package org.cyber.utbot.api.utils.vulnerability.parsers

import com.google.gson.Gson
import com.google.gson.reflect.TypeToken
import org.cyber.utbot.api.abstraction.VulnerabilityCheck
import org.cyber.utbot.api.abstraction.VulnerabilityCheckInfo
import org.cyber.utbot.api.utils.FunctionId
import org.cyber.utbot.api.utils.GENERATE_METHOD_ARGUMENTS_PREFIX
import org.cyber.utbot.api.utils.VULNERABILITY_CHECKS_FUNCTIONS_CLASS_NAME
import org.cyber.utbot.api.utils.additions.vulnerability.createConstraintsFunction
import java.io.File

object ArgumentsVulnerabilityChecksCreator: AbstractVulnerabilityChecksCreator() {
    private val gson = Gson()
    private val type = object : TypeToken<List<List<Any>>>() {}.type
    private var argumentsGenerateNumber = 0

    private fun check(argumentsList: List<List<Any>>): List<FunctionId> =
        listOf(VULNERABILITY_CHECKS_FUNCTIONS_CLASS_NAME to createConstraintsFunction("${GENERATE_METHOD_ARGUMENTS_PREFIX}${argumentsGenerateNumber++}", argumentsList).name)
//        throw CyberException("ArgumentsVulnerabilityChecksCreator not yet implemented")

    override fun parseVulnerabilityCheckInfo(vulnerabilityCheckInfo: VulnerabilityCheckInfo): VulnerabilityCheck {
        val functionIds = check(vulnerabilityCheckInfo.paths.map {
            gson.fromJson<List<List<Any>>>(File(it).read(), type)
        }.flatten())
        return VulnerabilityCheck(functionIds = functionIds, description = vulnerabilityCheckInfo.description)
    }
}
